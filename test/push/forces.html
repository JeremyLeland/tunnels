<title>Repulsion forces</title>
<link rel="stylesheet" href="../grid.css">

<body></body>

<script type="module">

  import { Game } from '../../src/Game.js';
  import { Entity } from '../../src/Entity.js';
  import { Wall } from '../../src/Wall.js';

  import { ActorInfo } from '../../info/info.js';
  
  const game = new Game();
  game.start();

  const AVOID_DIST = 50;
  
  const balls = [
    new Entity( { x: 200, y: 200 }, ActorInfo.marine ),
    new Entity( { x: 400, y: 200 }, ActorInfo.marine ),
    new Entity( { x: 400, y: 400 }, ActorInfo.marine ),
    new Entity( { x: 200, y: 400 }, ActorInfo.marine ),
  ];

  const walls = [
    new Wall( [ [ 200, 600 ], [ 400, 500 ], [ 400, 650 ] ] ),
    new Wall( [ [ 500, 500 ], [ 700, 300 ], [ 700, 500 ] ] ),
  ];

  const player = balls[ 0 ];
  
  game.update = ( dt ) => {
    balls.forEach( ball => ball.update( dt ) );
  };

  game.draw = ( ctx ) => {
    balls.forEach( ball => {
      ball.draw( ctx );

      ball.dx = 0;
      ball.dy = 0;
    } );

    // ctx.strokeStyle = 'brown';
    walls.forEach( wall => wall.draw( ctx ) );

    // TODO: Do all pairs once, with nest for loops. Apply forces to both members of each pair.
    
    balls.forEach( from => {
      balls.forEach( to => {
        if ( from != to ) {
          const points = from.getClosestPoints( to );

          const angle = Math.atan2( points.closestB.y - points.closestA.y, points.closestB.x - points.closestA.x );
          const dist  = points.distance;

          const repulsion = Math.max( 0, 1 - dist / AVOID_DIST );
          const speed = to.info.maxSpeed * repulsion;

          to.dx += Math.cos( angle ) * speed;
          to.dy += Math.sin( angle ) * speed;

          ctx.beginPath();
          ctx.moveTo( points.closestA.x, points.closestA.y );
          ctx.lineTo( points.closestB.x, points.closestB.y );
          ctx.strokeStyle = `rgba( 0, 255, 0, ${ repulsion } )`;
          ctx.stroke();
        }
      } );

      walls.forEach( wall => {
        // const dist = wall.distanceTo( from.x, from.y ) - from.info.size / 2;
        // const dist = wall.getRayHit( from.x, from.y, -wall.normal.x, -wall.normal.y ) - from.info.size / 2;

        const points = from.getClosestPoints( wall );

        const angle = Math.atan2( points.closestB.y - points.closestA.y, points.closestB.x - points.closestA.x );
        const dist  = points.distance;

        const repulsion = Math.max( 0, 1 - dist / AVOID_DIST );
        const speed = from.info.maxSpeed * repulsion;

        from.dx -= Math.cos( angle ) * speed;
        from.dy -= Math.sin( angle ) * speed;
      } );
    } );

  };

  document.addEventListener( 'mousemove', e => {
    const x = e.clientX - game.scroll.x;
    const y = e.clientY - game.scroll.y;

    player.x = x;
    player.y = y;
  } );

</script>