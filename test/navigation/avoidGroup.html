<title>Group Avoiding Each Other</title>
<link rel="stylesheet" href="../../style.css">

<script type="module">
  import { Entity } from '../../src/Entity.js';
  import { Game } from '../../src/Game.js';
  import { AvoidingActor } from '../../src/AvoidingActor.js';

  class Obstacle extends Entity {
    size = 20;

    drawEntity( ctx ) {
      ctx.beginPath();
      ctx.arc( 0, 0, this.size, 0, Math.PI * 2 );
      ctx.fillStyle = 'brown';
      ctx.fill();
      ctx.strokeStyle = 'black';
      ctx.stroke();
    }
  }

  class Player extends AvoidingActor {
    size = 10;
    speed = 0.1;
    turnSpeed = 0.008;

    drawEntity( ctx ) {
      ctx.beginPath();
      ctx.moveTo( this.size, 0 );
      ctx.arc( 0, 0, this.size, Math.PI - 1, Math.PI + 1 );
      ctx.closePath();
      ctx.fillStyle = 'green';
      ctx.fill();
      ctx.strokeStyle = 'black';
      ctx.stroke();
    }
  }

  let obstacles = [];
  let players = Array.from( Array( 5 ), ( _, ndx ) => new Player( { x: ndx * 50, y: 50 } ) );

  const game = new Game();

  game.update = ( dt ) => {
    if ( !game.keysPressed.has( ' ' ) ) {
      const everything = players.concat( obstacles );
      players.forEach( e => e.update( dt, everything ) );
    }
  };

  game.draw = ( ctx ) => {
    obstacles.forEach( e => e.draw( ctx ) );
    players.forEach( e => e.draw( ctx ) );
  };


  document.addEventListener( 'mousedown', e => {
    if ( e.button == 0 )  addObstacle( e.clientX, e.clientY );
    if ( e.button == 2 )  removeObstacle( e.clientX, e.clientY );
  } );

  document.addEventListener( 'mousemove', e => {
    players.forEach( player =>
      player.target = { x: e.clientX, y: e.clientY }
    );
  } );

  function addObstacle( x, y ) {
    obstacles.push( new Obstacle( { x: x, y: y } ) );
  }

  function removeObstacle( x, y ) {
    if ( obstacles.length > 0 ) {
      let closest = obstacles.map( 
        e => ( { entity: e, dist: Math.hypot( e.x - x, e.y - y ) } )
      ).reduce( 
        ( closest, e ) => e.dist < closest.dist ? e : closest
      );
      
      obstacles = obstacles.filter( e => e != closest.entity );
    }
  }

</script>